name: Automatic GSI Builder

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'ROM Manifest URL'
        required: true
        default: 'https://github.com/LineageOS/android.git'
      rom_branch:
        description: 'ROM Branch'
        required: true
        default: 'lineage-22.1'
      build_variant:
        description: 'Build Variant'
        required: true
        default: 'treble_arm64_bvN-userdebug'
        type: choice
        options:
          - treble_arm64_bvN-userdebug
          - treble_arm64_bgN-userdebug
          - treble_a64_bvN-userdebug
          - treble_a64_bgN-userdebug

env:
  ROM_URL: ${{ github.event.inputs.rom_url }}
  ROM_BRANCH: ${{ github.event.inputs.rom_branch }}
  BUILD_VARIANT: ${{ github.event.inputs.build_variant }}
  PIXELDRAIN_API_KEY: ${{ secrets.PIXELDRAIN_API_KEY }}
  GOFILE_API_KEY: ${{ secrets.GOFILE_API_KEY }}
  CCACHE_COMPRESS: true
  CCACHE_MAXSIZE: 50G

jobs:
  build-gsi:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialize Build Environment
        id: init
        run: |
          echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
          echo "Menginstall dependencies..."
          
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            bc bison build-essential curl flex g++-multilib gcc-multilib git \
            gnupg gperf libxml2 lib32z1-dev liblz4-tool libncurses5-dev \
            libsdl1.2-dev libwxgtk3.0-gtk3-dev imagemagick git lunzip lzop \
            schedtool squashfs-tools xsltproc zip zlib1g-dev openjdk-11-jdk \
            python3 perl xmlstarlet virtualenv xz-utils rr jq libncurses5 \
            pngcrush lib32ncurses5-dev git-lfs libxml2-utils repo ccache

      - name: Setup SDK & Repo
        run: |
          echo "Setup repo command..."
          
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH
          
          git config --global user.name "GSI Builder"
          git config --global user.email "builder@gsi.local"
          git config --global color.ui false

      - name: Setup CCache
        run: |
          echo "Setup ccache..."
          
          export USE_CCACHE=1
          export CCACHE_COMPRESS=1
          export CCACHE_MAXSIZE=50G
          ccache -M 50G
          ccache -o compression=true

      - name: Sync ROM Source
        id: sync
        run: |
          echo "Initializing repo..."
          
          mkdir -p ~/rom && cd ~/rom
          repo init -u $ROM_URL -b $ROM_BRANCH --depth=1 --no-repo-verify
          
          echo "Adding Treble manifest..."
          
          git clone https://github.com/TrebleDroid/treble_manifest .repo/local_manifests -b android-15.0
          
          # Remove replace.xml untuk ROM non-AOSP
          if [[ "$ROM_URL" != *"android.git"* ]] || [[ "$ROM_URL" != *"platform"* ]]; then
            rm -f .repo/local_manifests/replace.xml
          fi
          
          echo "Syncing source (ini akan lama)..."
          
          repo sync -c -j$(nproc --all) --force-sync --no-tags --no-clone-bundle --optimized-fetch --prune 2>&1 | tee sync.log || {
            echo "Repo sync failed"
            exit 1
          }

      - name: Apply Treble Patches
        run: |
          echo "Applying Treble patches..."
          
          cd ~/rom
          
          # Download patches
          curl -L -o patches.zip https://github.com/TrebleDroid/treble_experimentations/releases/latest/download/patches-for-developers.zip
          unzip -q patches.zip -d patches/
          
          # Apply patches
          for patch in patches/*/; do
            if [ -d "$patch" ]; then
              project=$(basename "$patch")
              if [ -d "$project" ]; then
                cd "$project"
                git am ../patches/$project/*.patch 2>/dev/null || echo "Patch failed for $project, continuing..."
                cd ~/rom
              fi
            fi
          done

      - name: Generate Device Config
        run: |
          echo "Generating device config..."
          
          cd ~/rom
          
          # Detect ROM type untuk common.mk
          if [ -f "vendor/lineage/config/common_full_phone.mk" ]; then
            COMMON_MK="vendor/lineage/config/common_full_phone.mk"
          elif [ -f "vendor/aosp/config/common_full_phone.mk" ]; then
            COMMON_MK="vendor/aosp/config/common_full_phone.mk"
          else
            COMMON_MK=$(find vendor -name "common_full_phone.mk" 2>/dev/null | head -1)
          fi
          
          cd device/phh/treble
          bash generate.sh $COMMON_MK

      - name: Build GSI
        id: build
        continue-on-error: true
        run: |
          echo "Starting build..."
          
          cd ~/rom
          source build/envsetup.sh
          
          echo "Lunch $BUILD_VARIANT..."
          lunch $BUILD_VARIANT
          
          echo "Building system image (bisa 1-3 jam)..."
          
          WITHOUT_CHECK_API=true make -j$(nproc --all) systemimage 2>&1 | tee build.log
          
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
            echo "Build failed"
            exit 1
          fi

      - name: Compress & Upload
        id: upload
        if: steps.build.outputs.build_success == 'true'
        run: |
          echo "Compressing system image..."
          
          cd ~/rom/out/target/product/phh*/
          
          # Compress
          xz -9 -T$(nproc --all) -v -z system.img
          
          IMG_NAME="GSI-$(date +%Y%m%d)-${BUILD_VARIANT}.img.xz"
          mv system.img.xz $IMG_NAME
          
          echo "IMG_NAME=$IMG_NAME" >> $GITHUB_ENV
          echo "IMG_PATH=$(pwd)/$IMG_NAME" >> $GITHUB_ENV
          
          # Upload to PixelDrain
          echo "Uploading to PixelDrain..."
          
          if [ -n "$PIXELDRAIN_API_KEY" ]; then
            PD_RESPONSE=$(curl -T "$IMG_NAME" -u :$PIXELDRAIN_API_KEY https://pixeldrain.com/api/file/)
            PD_LINK=$(echo $PD_RESPONSE | jq -r '.link // empty')
            echo "PIXELDRAIN_LINK=$PD_LINK" >> $GITHUB_ENV
          fi
          
          # Upload to GoFile
          echo "Uploading to GoFile..."
          
          if [ -n "$GOFILE_API_KEY" ]; then
            GF_SERVER=$(curl -s https://api.gofile.io/getServer | jq -r '.data.server')
            GF_RESPONSE=$(curl -F "file=@$IMG_NAME" -H "Authorization: Bearer $GOFILE_API_KEY" "https://$GF_SERVER.gofile.io/uploadFile")
            GF_LINK=$(echo $GF_RESPONSE | jq -r '.data.downloadPage // empty')
            echo "GOFILE_LINK=$GF_LINK" >> $GITHUB_ENV
          fi

      - name: Create Build Report
        run: |
          END_TIME=$(date +%s)
          START_TIME=${{ steps.init.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          DURATION_MIN=$((DURATION / 60))
          
          if [ "${{ steps.build.outputs.build_success }}" == "true" ]; then
            cat > build-report.txt << EOF
========================================
         GSI BUILD SUCCESS
========================================
Build Date: $(date)
Duration: ${DURATION_MIN} minutes

ROM Information:
- URL: $ROM_URL
- Branch: $ROM_BRANCH
- Variant: $BUILD_VARIANT

Download Links:
- PixelDrain: ${PIXELDRAIN_LINK:-"Not uploaded (no API key)"}
- GoFile: ${GOFILE_LINK:-"Not uploaded (no API key)"}

File: ${IMG_NAME}
========================================
EOF
          else
            cat > build-report.txt << EOF
========================================
          GSI BUILD FAILED
========================================
Build Date: $(date)
Duration: ${DURATION_MIN} minutes

ROM Information:
- URL: $ROM_URL
- Branch: $ROM_BRANCH
- Variant: $BUILD_VARIANT

Status: Build failed
Check build logs for details.
========================================
EOF
          fi

      - name: Upload Build Report
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ github.run_id }}
          path: build-report.txt
          retention-days: 30

      - name: Upload Download Links (on success)
        if: steps.build.outputs.build_success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: GSI-Image-${{ github.run_id }}
          path: ~/rom/out/target/product/phh*/*.img.xz
          retention-days: 7

      - name: Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_id }}
          path: |
            ~/rom/sync.log
            ~/rom/build.log
          retention-days: 7
